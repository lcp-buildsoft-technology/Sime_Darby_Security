<template>
  <div class="page" id="impromtu" data-name="impromtu">
    <div class="page-content">
      <!-- Static Navbar -->
      <div class="navbar">
        <div class="navbar-inner">
          <div class="left">
            <a class="link link_back back">
              <i class="material-icons"> arrow_back</i>
              <span class="if-not-md">Back</span>
            </a>
          </div>
          <div class="title">IMPROMTU</div>
          <div class="rightS"></div>
        </div>
      </div>
      
      <div class="visitor_content">
        <div class="card_width">
          <div
              data-pagination='{"el": ".swiper-pagination"}'
              data-space-between="50"
              class="swiper-container swiper-init demo-swiper" 
            >
              <div class="swiper-pagination"></div>
              <div class="swiper-wrapper" >
          <div class="desktop_view">
            
              <!-- <div class="swiper-slide" style="font-size: 18px;color:black">
              <div class="row">   
              <div class="col-25" style='text-align: center;'>
                  
                      <div class="custom-button delivery_btn">
                        <img src="./static/delivery.png" class="img_css" style='width:70px;height:70px;padding-top: 10px;'>
                      </div>
                      <div>
                          <h5> DELIVERY / COURIER SERVICE</h5>
                      </div>
                  
              </div>

              <div class="col-25" id="history_visitor_module" style='text-align: center;'>
        
                <div class="custom-button home_btn ">
                  <img src="./static/home.png" class="img_css" style='width:90px;height:90px;padding-top: 5px;'>
                </div>
                <div >
                    <h5>PRIVATE DELIVERY</h5> 
                </div>
            
              </div>



              <div class="col-25"  style='text-align: center;'> 
                  
                      <div class="custom-button taxi_btn ">
                        <img src="./static/taxi.png" class="img_css" style='width:90px;height:90px;padding-top: 5px;'>
                      </div>
                      <div>
                          <h5>TAXI</h5>
                      </div>
                  
              </div>     
                  
                  
              



              <div class="col-25" id="tour_module" style='text-align: center;'>
      
                <div class="custom-button truck_btn ">
                  <img src="./static/truck.png" class="img_css" style='width:90px;height:90px;padding-top: 5px;'>
                </div>
                <div>
                    <h5>GRABAGE TRUCK</h5>
                </div>
            
              </div>

            </div>
            </div>

            <div class="swiper-slide" style="font-size: 18px;color:black">
              <div class="row">  
              <div class="col-25" style='text-align: center;'>
                  
                      <div class="custom-button delivery_btn">
                        <img src="./static/delivery.png" class="img_css" style='width:70px;height:70px;padding-top: 10px;'>
                      </div>
                      <div>
                          <h5> DELIVERY / COURIER SERVICE</h5>
                      </div>
                  
              </div>

              <div class="col-25" id="history_visitor_module" style='text-align: center;'>
        
                <div class="custom-button home_btn ">
                  <img src="./static/home.png" class="img_css" style='width:90px;height:90px;padding-top: 5px;'>
                </div>
                <div >
                    <h5>PRIVATE DELIVERY</h5> 
                </div>
            
              </div>



              <div class="col-25"  style='text-align: center;'> 
                  
                      <div class="custom-button taxi_btn ">
                        <img src="./static/taxi.png" class="img_css" style='width:90px;height:90px;padding-top: 5px;'>
                      </div>
                      <div>
                          <h5>TAXI</h5>
                      </div>
                  
              </div>     
                  
                  
              



              <div class="col-25" id="tour_module" style='text-align: center;'>
      
                <div class="custom-button truck_btn ">
                  <img src="./static/truck.png" class="img_css" style='width:90px;height:90px;padding-top: 5px;'>
                </div>
                <div>
                    <h5>GRABAGE TRUCK</h5>
                </div>
            
              </div>

            </div>
            </div>
          </div>
        </div> -->
        </div>

        <div class="mobile_view">
          <!-- <div class="row" >
          
            <div class="col-25" style='text-align: center;'>
                
                    <div class="custom-button delivery_btn">
                      <img src="./static/delivery.png" class="img_css" style='width:50px;height:50px;'>
                    </div>
                    <div>
                        <h5> DELIVERY / COURIER SERVICE</h5>
                    </div>
                
            </div>

            <div class="col-25" id="history_visitor_module" style='text-align: center;'>
      
              <div class="custom-button home_btn ">
                <img src="./static/home.png" class="img_css" style='width:60px;height:60px;'>
              </div>
              <div >
                  <h5>PRIVATE ADDRESS</h5> 
              </div>
          
            </div>



            <div class="col-25"  style='text-align: center;'> 
                
                    <div class="custom-button taxi_btn ">
                      <img src="./static/taxi.png" class="img_css" style='width:60px;height:60px;'>
                    </div>
                    <div>
                        <h5>TAXI</h5>
                    </div>
                
            </div>     
                
                
            



            <div class="col-25" id="tour_module" style='text-align: center;'>
    
              <div class="custom-button truck_btn ">
                <img src="./static/truck.png" class="img_css" style='width:60px;height:60px;'>
              </div>
              <div>
                  <h5>GRABAGE TRUCK</h5>
              </div>
          
            </div>


          
        </div> -->
      </div>
    </div>
  </div>
          <form class="list" id="my-form" enctype="multipart/form-data">
            <ul>
             
              <li>
                <input type="hidden" name="is_notify" value="false" />
                <div class="item-content item-input item-input-outline">
                  <div class="item-inner">
                    <div
                      class="item-title item-label item-floating-label "
                      style="color:#FB6C5E;text-align: left"
                    >
                      <b>Device No.</b>
                    </div>
                    <div class="item-input-wrap">
                      <input
                        type="text"
                        class="impromt_check"
                        placeholder="Select Pass ID"
                        readonly="readonly"
                        id="demo-picker-device"
                        style="color:black;"
                      />
                      <span class="input-clear-button"></span>
                    </div>
                  </div>
                </div>
              </li>
              <li>
                <div class="item-content item-input item-input-outline">
                  <div class="item-inner">
                    <div
                      class="item-title item-label  item-floating-label"
                      style="color:#FB6C5E;text-align: left"
                    >
                      <b>Vehicle Plate No.</b>
                    </div>
                    <div class="item-input-wrap">
                      <input
                        type="text"
                        class="impromt_check"
                        name="visitor_car_plate"
                        placeholder=""
                        style="color:black;text-transform:uppercase"
                      />
                      <span class="input-clear-button"></span>
                    </div>
                  </div>
                </div>
              </li>
              <li id='address_check' class= 'desktop_view_1'>
                
              </li>
              <li id="address_check" class= 'mobile_view_1'>
                <div class="item-content item-input item-input-outline">
                  <div class="item-inner">
                    <div
                      class="item-title item-label item-floating-label"
                      style="color:#FB6C5E;text-align: left"
                    >
                      <b>Address</b>
                    </div>
                    <div class="item-input-wrap">
                      <input
                        type="text"
                        name="address"
                        class="walkin_check"
                        placeholder=" "
                        name="address"
                        style="color:black;"
                        readonly="readonly"
                        id="demo-picker-dependent"
                      />
                      
                      <span class="input-clear-button"></span>
                    </div>
                  </div>
                </div>
              </li>
              <!-- <li>
                <div class="item-content item-input item-input-outline">
                  <div class="item-inner">
                    <div
                      class="item-title item-label item-floating-label "
                      style="color:#FB6C5E;text-align: left"
                    >
                      <b>Purpose</b>
                    </div>
                    <div class="item-input-wrap">
                      <input
                        type="text"
                        name="reason"
                        class="impromt_check"
                        placeholder="Select Purpose"
                        readonly="readonly"
                        id="demo-picker-purpose"
                        style="color:black;"
                      />
                      <span class="input-clear-button"></span>
                    </div>
                  </div>
                </div>
              </li> -->
              <!-- <li>
                <div style="color:#FB6C5E;width:90%;margin-left:5%">
                  <b>With Address</b>
                  <label class="toggle address_toggle" style="float:right;">
                    <input type="checkbox"/>
                    <span class="toggle-icon"></span>
                  </label>
                </div>
              </li> -->
            </ul>
            <input type="hidden" name="deviceNumber" />
            <input type="hidden" name="lot" id='lot_new'/>
            <input type="hidden" name="street" id=street_new/>
            <input type="hidden" name="status" value="AIS" />
            <input type="hidden" name="entry_type" value="I" />
          </form>

          <!-- <a href="/camera_test/" class="button">test ip camera</a> -->

          <div style="margin-left:15px;margin-bottom: 5px;">
            <b style="display: inline-block;color:#333;">Preview </b>
          </div>

          <div class="preview">
            <div
              data-pagination='{"el": ".swiper-pagination"}'
              data-space-between="50"
              class="swiper-container swiper-init demo-swiper"
            >
              <div class="swiper-pagination"></div>
              <div class="swiper-wrapper">
                <div class="swiper-slide img-front camera_btn" x="EF" id="EF">
                  No Image (Car plate)
                </div>
                <div class="swiper-slide img-face camera_btn" x="FC" id="FC">
                  No Image (Face)
                </div>
                <div class="swiper-slide img-face camera_btn" x="IC" id="IC">
                  No Image (IC)
                </div>
              </div>
            </div>
          </div>

          <div class=" row ">
            <div class="col button button-outline button-round">
              <a
                class="button back link_back"
                style="border-color:darkgrey;color:darkgrey"
                href="#"
                ><b>Cancel</b></a
              >
            </div>
            <div class="col button button-outline button-round">
              <a
                class="button submit_btn"
                style="border-color:#00BE47;color:#00BE47;"
                href="#"
                ><b>Register</b></a
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
<style>
  /* .picker{
    height:350px !important;
  } */

  .select_reason{
    padding: 5px;
    border:1px solid #FB6C5E;
    
  }

  .required_field{
    padding: 10px;
    border:2px solid red;
  }

  .list_item_width{
    width: 96% !important;
  }

  .list_item_width2{
    width: 91.5% !important;
  }

  .picker-item{
    font-size: 13px;
  }
</style>
<script>
  import request from "../js/request.js";
  import socket from 'socket.io-client/dist/socket.io.js';
  import CONFIG from "../js/config.js";
  export default {
    data: function() {
      var app = this.$app;
      var auth = app.form.getFormData("auth");
      return {
        user: auth.user
      };
    },
    on: {
      pageInit: function() {
        var $$ = this.$$;
        var app = this.$app;
        var router = this.$router;
        var PassID;
        var boomgate_ip = ""
        var address_check_required;
        if(app.device.desktop){
          address_check_required = false;
        }else{
          address_check_required = true;
        }
        var auth = app.form.getFormData("auth");
        var security_id = auth.user.id
        var ip_cam = [];
        var reason_id='';
        app.dialog.preloader();
        var sck = socket.connect(CONFIG.SOCKET);
        $$('.link_back').on('click', function () {
          sck.emit("security_user", {
            id: auth.user.id,
            area: auth.user.area.id,
            role: "security",
            welcome:false
          });

        });
        

        function sliceIntoChunks(arr, chunkSize) {
            const res = [];
            for (let i = 0; i < arr.length; i += chunkSize) {
                const chunk = arr.slice(i, i + chunkSize);
                res.push(chunk);
            }
            return res;
        }

        if (app.device.desktop) {
        
        $$('.mobile_view').css("display", "none");
        $$('.mobile_view_1').css("display", "none");
        $$('.width_list').addClass('list_item_width')
      }else{
        $$('.desktop_view').css("display", "none");
        $$('.desktop_view_1').css("display", "none");
        $$('.width_list').addClass('list_item_width2')
      }

      $$("#address_check").css("visibility", "hidden");
        $$("#address_check").css("height", 0);
        $$(".mobile_view_1").css("visibility", "hidden");
                $$(".mobile_view_1").css("height", 0);
        request.get("reasons",{"Authorization":"JWT "+auth.token},null, function(data){
          console.log("here")
          console.log(data)

          var resons=data.results;
          var all_resons="";
          var reason_thumnail = [];
          var all_id = [];

          for(var i=0;i<resons.length;i++){
            purpose_list.push(resons[i].reason)
            console.log("hres")
            console.log(resons[i].reason)
            if(resons[i].thumbnail != null){
              reason_thumnail.push(resons[i]);
              
            }
           
          }
          
          var withThumbnail ;
          if (app.device.desktop) {
            withThumbnail = sliceIntoChunks(reason_thumnail, 4)
          }else{
            withThumbnail = sliceIntoChunks(reason_thumnail, 3)
          }
          console.log(withThumbnail)
          var display = '';
          var display_mobile = '';
          var display_1 ='';
          var display_2 ='';
          var display_3 ='';
          for(var i = 0; i < withThumbnail.length; i++){
            
             display_1 = '<div class="swiper-slide" style="font-size: 18px;color:black;padding:5px">'+
                           '<div class="row">';
            
              for(var j=0; j<withThumbnail[i].length;j++){
                display_2 +='<div class="col-25 reason_btn reason_click_'+withThumbnail[i][j].id+'" style="text-align: center;" data-name="'+withThumbnail[i][j].reason+'"  data-address="'+withThumbnail[i][j].address+'" data-id="'+withThumbnail[i][j].id+'" id="reason_click">'+
                  '<div class="custom-button ">'+
                    '<img src="'+withThumbnail[i][j].thumbnail+'" class="img_css" style="width:70px;height:70px;padding-top: 15px;">'+
                  '</div>'+
                  '<div>'+
                      '<input type="hidden" id="reason_id" name="reason" value="'+withThumbnail[i][j].id+'"/>'+
                      '<div style="font-size:15px;font-weight:bold;padding-top:5px">'+withThumbnail[i][j].reason+'</div>'+
                  '</div>'+
                '</div>';

                display_3 +='<div class="col-33 reason_btn reason_click_'+withThumbnail[i][j].id+'" style="text-align: center;"  data-name="'+withThumbnail[i][j].reason+'" data-address="'+withThumbnail[i][j].address+'" data-id="'+withThumbnail[i][j].id+'" id="reason_click">'+
                  '<div class="custom-button">'+
                    '<img src="'+withThumbnail[i][j].thumbnail+'" class="img_css" style="width:50px;height:50px;">'+
                  '</div>'+
                  '<div>'+
                      '<input type="hidden" id="reason_id" name="reason" value="'+withThumbnail[i][j].id+'"/>'+
                      '<h6>'+withThumbnail[i][j].reason+'</h6>'+
                  '</div>'+
                '</div>';

                all_id.push(withThumbnail[i][j].id);
              }
              display = display_1 + display_2+'</div></div>';
              display_mobile = display_1 + display_3+'</div></div>';
          }

          $$('.desktop_view').html(display);
          $$('.mobile_view').html(display_mobile);

          $$('.reason_btn').on("click", function() {
            var id = $$(this).data('id');
            var address = $$('.reason_click_'+id+'').data('address');
            var name = $$('.reason_click_'+id+'').data('name');
            console.log(address)
        
              if(address == 'true'){
                $$("#address_check").css("visibility", "visible");
                $$("#address_check").css("height", "auto");
                $$(".mobile_view_1").css("visibility", "visible");
                $$(".mobile_view_1").css("height", "auto");
                if(app.device.desktop){
                  address_check_required = false;
                }
              }else{
                $$("#address_check").css("visibility", "hidden");
                $$("#address_check").css("height", 0);
                $$(".mobile_view_1").css("visibility", "hidden");
                $$(".mobile_view_1").css("height", 0);
                $$('#browser').val('');
                $$('#street_new').val('');
                $$('#lot_new').val('');
                if(app.device.desktop){
                address_check_required = true;
                }
              }
             if($$('.reason_click_'+id+'').hasClass("select_reason")){
                $$('.reason_click_'+id+'').removeClass("select_reason");
                $$("#address_check").css("visibility", "hidden");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                $$("#address_check").css("height", 0);
                $$(".mobile_view_1").css("visibility", "hidden");
                $$(".mobile_view_1").css("height", 0);
                reason_id = '';
              }else{
                $$('.reason_click_'+id+'').addClass("select_reason");
                reason_id = name
                for(var i=0 ; i<all_id.length;i++){
                   if(all_id[i] != id){
                    $$('.reason_click_'+all_id[i]+'').removeClass("select_reason");
                   }
                }
              
              }
            
          });

      



        });
      
        
        var toggle = app.toggle.create({
          el: ".address_toggle",
          on: {
            change: function() {
              if (toggle.checked) {
                console.log("checked");
                $$("input[name='address']").val("true");
                $$("#address_check").css("visibility", "visible");
                $$("#address_check").css("height", "auto");
              } else {
                console.log("not checked");
                $$("input[name='address']").val("false");
                $$("#address_check").css("visibility", "hidden");
                $$("#address_check").css("height", 0);
              }
            }
          }
        });
        request.get(
          "security_ipcam",
          { Authorization: "JWT " + auth.token },
          null,
          function(data) {
            for (var i = 0; i < data.results.length; i++) {
              ip_cam[data.results[i].type] = data.results[i].url;
            }
            console.log(ip_cam);
          }
        );

        request.get(
          "security_boomgate",
          { Authorization: "JWT " + auth.token },
          null,
          function(data) {
            var gate_type="E"
            for (var i = 0; i < data.length; i++) {
            if (data[i].type == gate_type) {
              boomgate_ip = data[i].url;
            }
          }


           
          }
        );

        var address;
        var streetVendor = {};
        request.get(
          "security_street",
          { Authorization: "JWT " + auth.token },
          null,
          function(data) {
            app.dialog.close();

            address = data.results;
            console.log(data);

            var street = [];
            var streetValue = [];
            var streetLot = {};
            var data_street;
           
            for (var z = 0; z < address.length; z++) {
              if (address[z].lot_set.length != 0) {
                var temp = [];
                var temp2 = [];
                for (var y = 0; y < address[z].lot_set.length; y++) {
                  if (address[z].lot_set[y].has_resident == true || address[z].lot_set[y].has_resident == false) {
                    temp.push(address[z].lot_set[y].name);
                    temp2.push(address[z].lot_set[y].id);

                      // data_street +='<option value="'+address[z].lot_set[y].id+'">'+address[z].lot_set[y].name+'</option>';
                    
                   
                  }
                }
                streetVendor[address[z].name] = temp;
                streetLot[address[z].id] = temp2;

                if (temp.length > 0 && temp2.length > 0) {
                  street.push(address[z].name);
                  streetValue.push(address[z].id);
                }

               
              }
              //streetVendor= street;
            }

            for (var i=0; i<address.length; i++) {
                 
              for(var j=0; j<address[i].lot_set.length; j++) {
                data_street +='<option data-street="'+address[i].id+'" data-house="'+address[i].lot_set[j].id+'" value="'+address[i].name+' '+address[i].lot_set[j].name+'"></option>';
              }
                 
            }

                console.log(address)
           
            var address_check = '<div class="item-content item-input item-input-outline address_required">'+
                  '<div class="item-inner ">'+
                    '<div class="item-title item-label item-floating-label" style="color:#FB6C5E;text-align: left">'+
                    '<b>Address</b>'+
                    '</div>'+
                    '<div class="item-input-wrap">'+
                    '<input  class="item-input-wrap width_list"  style="color:black;font-size: 18px;border:1px solid #FB6C5E;" list="browsers" name="browser" id="browser">'+
                    '<datalist id="browsers">'+
                      data_street+
                    '</datalist>'+
                  '</div>  '+
             '</div>'+
            '</div>';
            $$('#address_check').html(address_check);
            if (app.device.desktop) {
        
        
        $$('.width_list').addClass('list_item_width')
      }else{
        
        $$('.width_list').addClass('list_item_width2')
      }

      if(!app.device.desktop){
            var pickerDevice1;

            var pickerDependent = app.picker.create({
              inputEl: "#demo-picker-dependent",
              rotateEffect: true,
              formatValue: function(values, displayValues) {
                return displayValues;
              },
              cols: [
                {
                  textAlign: "left",
                  values: streetValue,
                  displayValues: street,
                  onChange: function(picker, lot, disval) {
                    if (picker.cols[1].replaceValues) {
                      picker.cols[1].replaceValues(
                        streetLot[lot],
                        streetVendor[disval]
                      );
                      $$("input[name='lot']").val(streetLot[lot][0]);
                      console.log(streetLot[lot][0])
                    }
                    $$("input[name='street']").val(lot);
                    $$('#street_new').val(lot);

                    console.log(lot)
                   
                  }
                },
                {
                  displayValues: streetVendor[street[0]],
                  values: streetLot[streetValue[0]],
                  width: 160,
                  onChange: function(picker, lot) {
                    $$("input[name='lot']").val(lot);
                    $$('#lot_new').val(lot);
                    console.log(lot)
                   
                  }
                }
              ],
              on: {
                opened: function() {
                  if (pickerDevice1) {
                    pickerDevice1.destroy();
                  }

                  $$("#demo-picker-device1").val("");
                },
                close: function() {
                  
                  console.log("asdas");
                  var t = $$("#demo-picker-dependent")
                    .val()
                    .split(",");

                 
            

 
                }
              }
            });
          }
          },function(error) {
                console.log(error);
                app.dialog.close();
                var dialog1 = app.dialog.create({
                    title: 'Sorry to have you waiting.',
                    text: 'We currently facing high traffic on billing-related action.<br><br>Please try again<br>Thank you for your patience :)',
                    buttons: [
                    // {
                    //     text: 'RETRY NOW',
                    //     onClick: function () {
                    //         clearInterval(myTimer);
                    //         router.refreshPage('/');
                            
                    //     }
                    // },
                    {
                        text: 'Close',
                        onClick: function () {
                          router.back("/main/", { force: true });
                            app.dialog.close()
                        }
                    }
                    ]
                })
                
              }
        );

        //get device no. , need change api
        request.get(
          "security_devicenumber",
          { Authorization: "JWT " + auth.token },
          null,
          function(data) {
            PassID = data.results;
            console.log(PassID);
            app.dialog.close();
            var dev_no = [];
            var dev_val = [];
            for (var z = 0; z < PassID.length; z++) {
              dev_no.push(PassID[z].device_no);
              dev_val.push(PassID[z].id);
            }

            var pickerDevice = app.picker.create({
              inputEl: "#demo-picker-device",
              formatValue: function(values, displayValues) {
                return displayValues;
              },
              cols: [
                {
                  textAlign: "center",
                  displayValues: dev_no,
                  values: dev_val,
                  onChange: function(picker, val) {
                    $$('input[name="deviceNumber"]').val(val);
                  }
                }
              ]
            });
          }
        );

        var purpose_list = [];

        var pickerDevice_purpose;

        request.get("reasons",{"Authorization":"JWT "+auth.token},null, function(data){
          console.log("here")
          console.log(data)

        var resons=data.results;
        var all_resons="";
        for(var i=0;i<resons.length;i++){
          
          purpose_list.push(resons[i].reason)
          console.log("hres")
          console.log(resons[i].reason)
        }

        pickerDevice_purpose = app.picker.create({
          inputEl: "#demo-picker-purpose",
          cols: [
            {
              textAlign: "center",
              values: purpose_list
            }
          ]
        });
        });

        var imgs = [];
        //*camera_btn function////////////////////////////////////////////////////////////////////////////////////////////////
        $$(".camera_btn").on("click", function() {
          var facecam = ip_cam.FC;
          var frontcam = ip_cam.EF;
          var iccam = ip_cam.IC;
          var x = $$(this).attr("x");
          if (app.device.android || app.device.ios) {
            app.dialog
              .create({
                title: "Camera Option",

                buttons: [
                  {
                    text: "IVMS"
                  },
                  {
                    text: "Phone camera"
                  },
                  {
                    text: "Close"
                  }
                ],
                onClick: function(dialog, index) {
                  if (index === 0) {
                    //Button 1 clicked
                    if (app.device.desktop) {
                      ivms_capture(x, frontcam, facecam, iccam);
                    }else{
                      if (navigator.connection.type === "wifi" ) {
                        ivms_capture(x, frontcam, facecam, iccam);
                      console.log(true)
                    } else {
                      var dialog1 = app.dialog.create({
                          title: 'Open Boom Gate Failed',
                          text: 'Currently is using Mobile Data Plan. Please use phone camera to capture image',
                          buttons: [
                            {
                              text: 'Close',
                              onClick: function () {
                                app.dialog.close();
                              }
                            }
                          ]
                        })

                        dialog1.open()

                      console.log(false)
                    }
                  }
                  } else if (index === 1) {
                    //Button 2 clicked
                    // cameara pugin deprecated!
                    console.log("camera");
                    document.addEventListener(
                      "deviceready",
                      onDeviceReady,
                      false
                    );
                    function onDeviceReady() {
                      console.log(navigator.camera);
                    }

                    console.log(x);

                    navigator.camera.getPicture(onSuccess, onFail, {
                      quality: 50,
                      destinationType: Camera.DestinationType.DATA_URL
                    });

                    function onSuccess(imageURI) {
                      const byteCharacters = atob(imageURI);
                      const byteArrays = [];

                      for (
                        let offset = 0;
                        offset < byteCharacters.length;
                        offset += 512
                      ) {
                        const slice = byteCharacters.slice(
                          offset,
                          offset + 512
                        );

                        const byteNumbers = new Array(slice.length);
                        for (let i = 0; i < slice.length; i++) {
                          byteNumbers[i] = slice.charCodeAt(i);
                        }

                        const byteArray = new Uint8Array(byteNumbers);
                        byteArrays.push(byteArray);
                      }

                      const blob = new Blob(byteArrays, { type: "jpg" });

                      console.log(blob);
                      var im = new Image();
                      var url = window.URL || window.webkitURL;
                      im.className = "custom-img";
                      im.src = url.createObjectURL(blob);

                      $$("#" + x).html("");
                      $$("#" + x).append(im);

                      //imgs.push({"name":x,"value":imageURI.substr(imageURI.lastIndexOf('/')+1)});
                      imgs[x] = blob;
                    }

                    function onFail(message) {
                      app.dialog.alert("Failed because: " + message, "");
                    }
                  }else if(index === 2){
                    app.dialog.close();
                  }
                },
                verticalButtons: true
              })
              .open();
          } else {
            ivms_capture(x, frontcam, facecam, iccam);
          }
        });

        function ivms_capture(x, frontcam, facecam, iccam) {
          app.dialog.preloader("Capture Image...");

          if (x == "EF") {
            console.log("Front:" + frontcam);
            var $this = $$("#" + x);
            request.getimg(
              frontcam,
              null,
              function(data) {
                var im = new Image();
                var url = window.URL || window.webkitURL;
                im.className = "custom-img";
                im.src = url.createObjectURL(data);
                if (data.size <= 100) {
                  app.dialog.close();
                  app.dialog.alert("Unable to connect to Camera!", "");
                } else {
                  $this.html("");
                  $this.append(im);
                  imgs[x] = data;
                  app.dialog.close();
                }
              },
              function(error) {
                console.log(error);
                app.dialog.close();
                app.dialog.alert("Unable to connect to Camera!", "");
              }
            );

            request.getimg(
              facecam,
              null,
              function(data) {
                var im = new Image();
                var url = window.URL || window.webkitURL;
                im.className = "custom-img";
                im.src = url.createObjectURL(data);

                console.log(data);
                if (data.size <= 100) {
                  app.dialog.close();
                  app.dialog.alert("Unable to connect to Camera!", "");
                } else {
                  $$("#FC").html("");
                  $$("#FC").append(im);
                  imgs['FC'] = data;
                  app.dialog.close();
                }
              },
              function(error) {
                console.log(error);
                app.dialog.close();
                app.dialog.alert("Unable to connect to Camera!", "");
              }
            );

            request.getimg(
              iccam,
              null,
              function(data) {
                var im = new Image();
                var url = window.URL || window.webkitURL;
                im.className = "custom-img";
                im.src = url.createObjectURL(data);
                console.log(data)
                
                  if (data.size == 26) {
                    app.dialog.close();
                    app.dialog.alert("Please insert IC.", "");
                    console.log(data.size)
                  } else if (data.size <= 100) {
                    app.dialog.close();
                    app.dialog.alert("Unable to connect to Camera!", "");
                  } else {
                    $$('#IC').html("");
                    $$('#IC').append(im);
                    imgs['IC'] = data;
                    app.dialog.close();
                  }
                

                console.log(data);
              },
              function(error) {
                console.log(error);
                app.dialog.close();
                app.dialog.alert("Unable to connect to Camera!", "");
              }
            );

          } else if (x == "FC") {
            console.log("Face:" + facecam);
            var $this = $$("#" + x);
            request.getimg(
              facecam,
              null,
              function(data) {
                var im = new Image();
                var url = window.URL || window.webkitURL;
                im.className = "custom-img";
                im.src = url.createObjectURL(data);

                console.log(data);
                if (data.size <= 100) {
                  app.dialog.close();
                  app.dialog.alert("Unable to connect to Camera!", "");
                } else {
                  $this.html("");
                  $this.append(im);
                  imgs[x] = data;
                  app.dialog.close();
                }
              },
              function(error) {
                console.log(error);
                app.dialog.close();
                app.dialog.alert("Unable to connect to Camera!", "");
              }
            );

            request.getimg(
              frontcam,
              null,
              function(data) {
                var im = new Image();
                var url = window.URL || window.webkitURL;
                im.className = "custom-img";
                im.src = url.createObjectURL(data);
                if (data.size <= 100) {
                  app.dialog.close();
                  app.dialog.alert("Unable to connect to Camera!", "");
                } else {
                  $$('#EF').html("");
                  $$('#EF').append(im);
                  imgs['EF'] = data;
                  app.dialog.close();
                  console.log('EFSA')
                }
              },
              function(error) {
                console.log(error);
                app.dialog.close();
                app.dialog.alert("Unable to connect to Camera!", "");
              }
            );

            request.getimg(
              iccam,
              null,
              function(data) {
                var im = new Image();
                var url = window.URL || window.webkitURL;
                im.className = "custom-img";
                im.src = url.createObjectURL(data);

             
                  if (data.size == 26) {
                    app.dialog.close();
                    app.dialog.alert("Please insert IC.", "");
                    console.log(data.size)
                  } else if (data.size <= 100) {
                    app.dialog.close();
                    app.dialog.alert("Unable to connect to Camera!", "");
                  } else {
                    $$('#IC').html("");
                    $$('#IC').append(im);
                    imgs['IC'] = data;
                    app.dialog.close();
                  }
                
                console.log(data.blob.type);
              },
              function(error) {
                console.log(error);
                app.dialog.close();
                app.dialog.alert("Unable to connect to Camera!", "");
              }
            );

          } else if (x == "IC") {
            console.log("IC:" + iccam);
            var $this = $$("#" + x);
            request.getimg(
              iccam,
              null,
              function(data) {
                var im = new Image();
                var url = window.URL || window.webkitURL;
                im.className = "custom-img";
                im.src = url.createObjectURL(data);

                
                  if (data.size == 26) {
                    app.dialog.close();
                    app.dialog.alert("Please insert IC.", "");
                    console.log(data.size)
                  } else if (data.size <= 100) {
                    app.dialog.close();
                    app.dialog.alert("Unable to connect to Camera!", "");
                  } else {
                    $$('#IC').html("");
                    $$('#IC').append(im);
                    imgs['IC'] = data;
                    app.dialog.close();
                  }
                

                console.log(data.Blob)
              },
              function(error) {
                console.log(error);
                app.dialog.close();
                app.dialog.alert("Unable to connect to Camera!", "");
              }
            );
          }
        }
        
        $$(".submit_btn").on("click", function() {
          var f = document.getElementById("my-form");
          var Fdata = new FormData(f);
          console.log(Fdata);
          console.log(f);
          if(app.device.desktop){
            var shownVal = document.getElementById("browser").value;
            var house = $$("#browsers [value='" + shownVal + "']").data('house');
            var street = $$("#browsers [value='" + shownVal + "']").data('street');
            console.log(house);
            console.log(street);
            if(house !=undefined && street != undefined){
              address_check_required = true
              Fdata.append("lot",house)
              Fdata.append("street",street)
            }else{
              console.log(address_check_required)
              if(address_check_required == false){
                
                if(house != undefined || street != undefined){
                  address_check_required = true
                }else{
                  $$('#browser').val('');
                  $$('#browser').focus();
                  $$('.address_required').addClass('required_field');
                  address_check_required = false
                  app.dialog.close();
                  app.dialog.alert("Invalid Address...", "");
                  
                }
              }
            }
          }else{

          }
          
          
          for (const [key, value] of Object.entries(imgs)) {
            switch (key) {
              case "IC":
                console.log(value)
                if(value != ''){
                  Fdata.append("identity_image", value, key + ".jpg");
                }else{
                  Fdata.append("identity_image", '');
                }
                break;
              case "EF":
                Fdata.append("entry_car_plate_image", value, key + ".jpg");
                break;
              case "FC":
                Fdata.append("driver_image", value, key + ".jpg");
                break;
            }
          }
          Fdata.append("security", security_id);
          console.log(reason_id)
          Fdata.append("reason",reason_id)
          var isValid = true;
          if(reason_id != ''){
            isValid = true;
          }else{
            app.dialog.close();
            app.dialog.alert("All field must be insert!", "");
            isValid = false;
          }
           

          // $$(".impromt_check").each(function() {
          //   console.log($$(this).attr("id"));
          //   if ($$(this).val() == "") {
          //     isValid = false;
          //   }
          // });
          
          if (isValid && address_check_required) {
            if(reason_id != 'UTILITIES'){
            if (imgs.EF != null && imgs.FC != null && imgs.IC != null) {
              app.dialog.preloader();
              request.postFormData(
                "visitor_entry",
                { Authorization: "JWT " + auth.token },
                Fdata,
                function(data) {
                  app.dialog.close();
                  console.log(data);

                  if (data.status == "success") {
                    app.dialog.alert("Impromtu Entry Created!", "");
                   

                    if (app.device.desktop) {
                        request.getimg(boomgate_ip, null, function(data) {
                        console.log(data);
                      });
                    }else{
                      if (navigator.connection.type === "wifi" ) {
                        request.getimg(boomgate_ip, null, function(data) {
                      console.log(data);
                    });
                    } else {
                      var dialog1 = app.dialog.create({
                          title: 'Open Boom Gate Failed',
                          text: 'Currently is using Mobile Data Plan. Please use manual button to open the boomgate ',
                          buttons: [
                            {
                              text: 'Close',
                              onClick: function () {
                                app.dialog.close();
                              }
                            }
                          ]
                        })

                        dialog1.open()
                      
                      console.log(false)
                    }
                  }

                    router.back("/main/", { force: true });
                  }
                },
                function(xhr, status) {
                  //error

                  app.dialog.close();
                  app.dialog.alert("Please try again.", "Register Impromptu Failed");
                }
              );
            } else {
              app.dialog.close();
              app.dialog.alert("Please capture all image!", "");
            }

          }else{
            if (imgs.EF != null && imgs.FC != null) {
              app.dialog.preloader();
              request.postFormData(
                "visitor_entry",
                { Authorization: "JWT " + auth.token },
                Fdata,
                function(data) {
                  app.dialog.close();
                  console.log(data);

                  if (data.status == "success") {
                    app.dialog.alert("Impromtu Entry Created!", "");
                    // request.getimg(boomgate_ip, null, function(data) {
                    //   console.log(data);
                    // });

                    if (app.device.desktop) {
                        request.getimg(boomgate_ip, null, function(data) {
                        console.log(data);
                      });
                    }else{
                      if (navigator.connection.type === "wifi" ) {
                        request.getimg(boomgate_ip, null, function(data) {
                      console.log(data);
                    });
                    } else {
                      var dialog1 = app.dialog.create({
                          title: 'Open Boom Gate Failed',
                          text: 'Currently is using Mobile Data Plan. Please use manual button to open the boomgate ',
                          buttons: [
                            {
                              text: 'Close',
                              onClick: function () {
                                app.dialog.close();
                              }
                            }
                          ]
                        })

                        dialog1.open()
                      
                      console.log(false)
                    }
                  }

                    router.back("/main/", { force: true });
                  }
                },
                function(xhr, status) {
                  //error

                  app.dialog.close();
                  app.dialog.alert("Please try again.", "Register Impromptu Failed");
                }
              );
            } else {
              app.dialog.close();
              app.dialog.alert("Please capture all image!", "");
            }
          }
          } else {
            
              app.dialog.close();
            app.dialog.alert("All field must be insert!", "");
              
            
            
          }
        });

        // end ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
      }
    }
  };
</script>
