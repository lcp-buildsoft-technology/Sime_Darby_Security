<template >


        <div class="page" id="visitor" data-name="visitor">
            <div class="page-content" >
              <!-- Static Navbar -->
              <div class="navbar">
                <div class="navbar-inner">
                  <div class="left">
                    <a class="link back">
                        <i class="material-icons"> arrow_back</i>
                      <span class="if-not-md">Back</span>
                    </a>
                  </div>
                  <div class="title">VISITOR</div>
                  <div class="right" style="margin-right: 15px;margin-top: 6px;"><a href="#" class="contact_btn"><i class="material-icons">contact_phone</i></a></div>
                </div>
              </div>
    
              <div class="toolbar tabbar toolbar-top" style="top:0;">
                  <div class="toolbar-inner">
                    <a href="#tab-1" class="tab-link tab-link-active">Check-in</a>
                    <a href="#tab-2" class="tab-link">Check-out</a>
           
                  </div>
                </div>
              <div class="tabs-swipeable-wrap" style="height:auto;">
                <div class="tabs">
                  <div id="tab-1" class="page-content tab tab-active" style="padding-top:0;">
                    <div >
                      <div class="visitor_content">
                      
                           <div class="visitor_scroll_view" id="visitor_scroll_view_in">
                              <div class="approved_entry_list"></div>
                              <div class="rejected_entry_list"></div>
                              <div class="pending_entry_list"></div>
                            </div>                     
                      
                      </div>
                    </div>
                  </div>
                  <div id="tab-2" class="page-content tab" style="padding-top:0;">
                    <div >
                        <div class="visitor_content">
                        
                            <div class="visitor_scroll_view" id="visitor_scroll_view_out">
                            </div>
                       </div>
                     
                    </div>
                  </div>
              
                </div>
              </div>
            





             
                  
                  
                  
             
                  
                  
        
             






               <div class="visitor_content" style="padding-top:2.5vh;border-top: solid #FB6C5E">

               <div  id="button-part">
               <div class="row">
                    <!-- Each "cell" has col-[width in percents] class -->
                    <div class="col-50" style='text-align: center;'>
                        
                            <div class="custom-button1   popover-open" data-popover=".popover-links">
                                <i class="material-icons custom-icon1"> directions_car</i>
                            </div>
                            <div class="custom-label1">
                                <h3>Open Boom Gate</h3>
                            </div>
                        
                    </div>


                    <div class="col-50" style='text-align: center;'> 
                        
                            <div class="custom-button1 history_btn">
                                <i class="material-icons custom-icon1"> dvr</i>
                            </div>
                            <div class="custom-label1">
                                <h3>Visitor History</h3>
                            </div>
                        
                    </div>     
                </div>      
                        
                </div>
               
                </div>
    
              



                <div class="popover popover-links">
                  <div class="popover-inner">
                    <div class="list">
                      <ul>
                        <li><a class="list-button item-link boom-gate-btn popover-close" href="#" data-value="E">Check-in</a></li>
                        <li><a class="list-button item-link boom-gate-btn popover-close" href="#" data-value="X">Check-out</a></li>
                 
                      </ul>
                    </div>
                  </div>
                </div>

            </div>
          </div>
          
    </template>


    
<script>
        import request from '../js/request.js';
        import socket from 'socket.io-client/dist/socket.io.js';
        import CONFIG from "../js/config.js";
        export default {
        
            data:function(){
              var dynamicPopup;
              var app=this.$app;
              var auth = app.form.getFormData("auth");
              
              return{
                user:auth.user,
              }
            },
        on:{
          
        pageInit:function(){
          var $$=this.$$;
             var app=this.$app;
             var router=this.$router;
             var resons;
             var auth = app.form.getFormData("auth");
  
            //socket
            var sck = socket.connect(CONFIG.SOCKET);
          
            console.log(auth);
            sck.emit("user",{id:auth.user.id,area:auth.user.area,role:"security"});
          
            var gate_type;

            if (app.device.desktop) {
             
              $$('.contact_btn').remove();
            }



            //get list when page load
            request.get("visitor_entry",{"Authorization":"JWT "+auth.token},null,function(data){
              console.log(data);
            
            var list_item=[];
              for(var i=0;i<data.length;i++){
                
                if(data[i].status!="PEX"){
                  var new_entry_item="";
            var color="";
            var status="";
          
            
                  if(data[i].status=="AIR"){
              color="forestgreen";
              status="Approved";
            }else if(data[i].status=="RIR"){
              color="red";
              status="Rejected";
              
            }
            else if(data[i].status=="PEN"){
              color="#FB6C5E";
              status="Pending";
              
            }

            var status_id="status_"+data[i].tracker_id;
            var card_id="card_"+data[i].tracker_id;

            var address="";
            if(data[i].entry_type!="I"){
              address=  data[i].lot.name+","+data[i].lot.street.name;
            }
            new_entry_item ="<div class='card  card_in card_width "+card_id+" '  >"+
                    "<div class='card-content card-click  content_heigt' visitor_id='"+data[i].tracker_id+"'>"+
                      '<div class="row no-gap">'+
                        '<div class="col-20 card-left-content">'+
                          '<div class="card-left-content_inner">'+
                            '<i class="material-icons">chevron_right</i>'+
                             '<p>CEHCK IN</p>'+
                         ' </div>'+
                        '</div>'+
                        '<div class="col-70 card-center-content">'+
                          '<div class="card-center-content_inner">'+
                            '<div>'+address+'</div>'+
                            '<div style="width: 100%;">'+
                                    '<div style="display: inline-block;">'+data[i].visitor_car_plate+'</div>'+
                                    '<div style="display: inline-block;position: absolute; right:0;margin-right:15px;">Status: <b class="'+status_id+'" style="color: '+color+'"> '+status+'</b></div>'+
                           ' </div>'+
                          '</div>'+
                        '</div>' +   
                        '<div class="col-10 card-right-content">'+
                          '<div class="card-right-content_inner">'+
                           ' <i class="material-icons">more_vert</i>'+
                         ' </div>'+
                       ' </div>'+

                      '</div>'+
                    '</div>'+
                 ' </div>';

         

            var content_item = {status:data[i].status, content:new_entry_item};
            list_item.push(content_item);


            }else{
                            var card_id="card_"+data[i].tracker_id;

                            var address="";
            if(data[i].entry_type!="I"){
              address=  data[i].lot.name+","+data[i].lot.street.name;
            }else{
              address ="Impromtu";
            }

                 var new_exit_item=  '<div class="card  card_in card_width '+card_id+'"   >'+
                  "<div class='card-content card-click  content_heigt' visitor_id='"+data[i].tracker_id+"'>"+
                         ' <div class="row no-gap">'+
                            '<div class="col-20 card-left-content">'+
                              '<div class="card-left-content_inner">'+
                               ' <i class="material-icons">chevron_left</i>'+
                                '<p>CEHCK OUT</p>'+
                              '</div>'+
                            '</div>'+
                            '<div class="col-70 card-center-content">'+
                              '<div class="card-center-content_inner">'+
                                   ' <div>'+address+'</div>'+
                                   ' <div>'+data[i].visitor_car_plate+'</div>'+
                              '</div>'+
                            '</div>'+
                            '<div class="col-10 card-right-content">'+
                              '<div class="card-right-content_inner">'+
                                '<i class="material-icons">more_vert</i>'+
                              '</div>'+
                           ' </div>'+

                            '</div>'+
                          '</div>'+
                        '</div>';

                        $$('#visitor_scroll_view_out').append(new_exit_item);
                          }
              }

   
              function compare( a, b ) {
  if ( a.status=="AIR" && b.status=='RIR' ){
    return -1;
  }
  if ( a.status=="AIR" && b.status=='PEN' ){
    return -1;
  }
  if ( a.status=="RIR" && b.status=='AIR' ){
    return 1;
  }
  if ( a.status=="RIR" && b.status=='PEN' ){
    return -1;
  }
  if ( a.status=="PEN" && b.status=='AIR' ){
    return 1;
  }
  if ( a.status=="PEN" && b.status=='RIR' ){
    return 1;
  }
  return 0;
}

list_item.sort( compare );
              

         
                function show_list(total,now){
               
                  var all=total;
                  var z=now
                
          
                  if(z<all){
                    var data_status =list_item[z].status;
                  var content = list_item[z].content;
                 
  if(data_status=="AIR"){
             setTimeout(function(){ $$('.approved_entry_list').append(content);
             z++;
            show_list(all,z);
            },100) 
           
            }else if(data_status=="RIR"){
              setTimeout(function(){ $$('.rejected_entry_list').append(content);
              z++;
            show_list(all,z);
                
            },100)
              
             
            }
            else if(data_status=="PEN"){
              setTimeout(function(){ $$('.pending_entry_list').append(content);
              z++;
            show_list(all,z);
        
            },100)
             
        
              
            }else{
              z++;
            show_list(all,z);
            }
          }
                }
               
         
                show_list(list_item.length,0);
           
          
        

      



            });









          //socket and prepend to list
    
    sck.on("visitor_arrive",function(data){
   
    
          request.get("visitor_entry/"+data.track_id,{"Authorization":"JWT "+auth.token},null,function(data){
      console.log(data);
       
               if(data.status!="PEX"){
                var new_entry_item="";
          var color="";
          var status="";
        
          
                if(data.status=="AIR"){
            color="forestgreen";
            status="Approved";
          }else if(data.status=="RIR"){
            color="red";
            status="Rejected";
            
          }
          else if(data.status=="PEN"){
            color="#FB6C5E";
            status="Pending";
            
          }
    
          var status_id="status_"+data.tracker_id;
          var card_id="card_"+data.tracker_id;

          var address="";
            if(data.entry_type!="I"){
              address=  data.lot.name+","+data.lot.street.name;
            }


          new_entry_item ="<div class='card card_in  card_width "+card_id+" ' >"+
            "<div class='card-content card-click  content_heigt' visitor_id='"+data.tracker_id+"'>"+
                    '<div class="row no-gap">'+
                      '<div class="col-20 card-left-content">'+
                        '<div class="card-left-content_inner">'+
                          '<i class="material-icons">chevron_right</i>'+
                           '<p>CEHCK IN</p>'+
                       ' </div>'+
                      '</div>'+
                      '<div class="col-70 card-center-content">'+
                        '<div class="card-center-content_inner">'+
                          '<div>'+address+'</div>'+
                          '<div style="width: 100%;">'+
                                  '<div style="display: inline-block;">'+data.visitor_car_plate+'</div>'+
                                  '<div style="display: inline-block;position: absolute; right:0;margin-right:15px;">Status: <b class="'+status_id+'" style="color: '+color+'"> '+status+'</b></div>'+
                         ' </div>'+
                        '</div>'+
                      '</div>' +   
                      '<div class="col-10 card-right-content">'+
                        '<div class="card-right-content_inner">'+
                         ' <i class="material-icons">more_vert</i>'+
                       ' </div>'+
                     ' </div>'+
    
                    '</div>'+
                  '</div>'+
               ' </div>';
    
    

    
        if(data.status=="AIR"){
          setTimeout(function(){  $$('.approved_entry_list').prepend(new_entry_item);},2000);
               
          }else if(data.status=="RIR"){
            
            setTimeout(function(){  $$('.rejected_entry_list').prepend(new_entry_item);},2000);
               
          }
          else if(data.status=="PEN"){
           
            setTimeout(function(){   $$('.pending_entry_list').prepend(new_entry_item);},2000);
          }
            
    
      
                        }else{
    
                          var card_id="card_"+data.tracker_id;

                          var address="";
            if(data.entry_type!="I"){
              address=  data.lot.name+","+data.lot.street.name;
            }else{
              address="Impromtu";
            }



               var new_exit_item=  '<div class="card  card_in card_width '+card_id+'"  >'+
                "<div class='card-content card-click  content_heigt' visitor_id='"+data.tracker_id+"'>"+
                       ' <div class="row no-gap">'+
                          '<div class="col-20 card-left-content">'+
                            '<div class="card-left-content_inner">'+
                             ' <i class="material-icons">chevron_left</i>'+
                              '<p>CEHCK OUT</p>'+
                            '</div>'+
                          '</div>'+
                          '<div class="col-70 card-center-content">'+
                            '<div class="card-center-content_inner">'+
                                 ' <div>'+address+'</div>'+
                                 ' <div>'+data.visitor_car_plate+'</div>'+
                            '</div>'+
                          '</div>'+
                          '<div class="col-10 card-right-content">'+
                            '<div class="card-right-content_inner">'+
                              '<i class="material-icons">more_vert</i>'+
                            '</div>'+
                         ' </div>'+
    
                          '</div>'+
                        '</div>'+
                      '</div>';
    
                      
                      setTimeout(function(){ $$('#visitor_scroll_view_out').prepend(new_exit_item);},2000);  
                    }
          });
        
      });
    
      
    //remove card item
      sck.on("visitor_remove",function(data){
       
        if($$(app.view.current.router.currentPageEl).data("name") == 'visitor'){
     
      
        $$('.card_'+data.track_id).removeClass("card_in");
        setTimeout(function(){ $$('.card_'+data.track_id).addClass("card_out");},500);
        setTimeout(function(){ $$('.card_'+data.track_id).remove();},1500);
      }
      });
    
    
    







      request.get("reasons",{"Authorization":"JWT "+auth.token},null, function(data){
 

                resons=data.results;
                var all_resons="";
for(var i=0;i<resons.length;i++){

  all_resons+= ' <li>'+
                         ' <label class="item-radio item-content">'+
                            '<input type="radio" name="reason-radio" value="'+resons[i].id+'" checked />'+
                            '<i class="icon icon-radio"></i>'+
                            '<div class="item-inner">'+
                              '<div class="item-title">'+resons[i].reason+'</div>'+
                            '</div>'+
                          '</label>'+
                        '</li>';

}

self.dynamicPopup = app.popup.create({
  el:".reasons",
   
  });
  $$('#reason-list').html(all_resons);
        
 });


             



//*contact_btn function////////////////////////////////////////////////////////////////////////////////////////////////
$$('.contact_btn').on('click', function () {

  router.navigate({name:"contact"});

      });



 // end ///////////////////////////////////////////////////////////////////////////////////////////////////////////////

 


//*contact_btn function////////////////////////////////////////////////////////////////////////////////////////////////
$$('.history_btn').on('click', function () {

  router.navigate({name:"history"});

      });



 // end ///////////////////////////////////////////////////////////////////////////////////////////////////////////////

 $$(".visitor_scroll_view").on('click',".card-click",function () {
 
  var id = $$(this).attr("visitor_id");
 
  var dynamicPopup ;
  app.dialog.preloader();
request.get("visitor_entry/"+id,{"Authorization":"JWT "+auth.token},null,function(data){

var status_txt='';
var txt_color='';
var button_part='';
var tittle='';
var check_out_img='';
if(data.status=="PEX"){
  tittle="Check-out";
  var check_out_img='<div class="swiper-slide img-front camera_btn" x="XF" id="EF"><img src="'+data.exit_car_plate_image+'" class="custom-img" ></div>';
}else{
  tittle="Check-in";
}

if(data.status=="PEN"){
  status_txt="Pending";
  txt_color ="yellow";
  
  button_part=    '<button class="col button button-fill button-round update-btn" style="color:white;background-color:#FB6C5E;margin-right:10px" action="back" id="'+data.tracker_id+'">BACK</button>';
                   
     
        
}else if(data.status=="AIR"){
  status_txt="Approved";
  txt_color ="#38DB69";

  button_part=    '<button class="col button button-outline button-round update-btn" style="color:red;border-color:red;margin-right:10px" action="reject" id="'+data.tracker_id+'">REJECT</button>'+
                    '<button class="col button button-outline button-round update-btn" style="color:#38DB69;border-color:#38DB69;margin-left:10px" action="approved" id="'+data.tracker_id+'">OPEN BOOM GATE</button>';
      

}else if(data.status=="RIR"){
  status_txt="Rejected";
  txt_color ="red";

  
button_part=    '<button class="col button button-outline button-round update-btn" style="color:	#FB6C5E;border-color:#FB6C5E;margin-right:10px" action="register" id="'+data.tracker_id+'">RE-REGISTER</button>'+
                '<button class="col button button-outline button-round update-btn" style="color:#38DB69;border-color:#38DB69;margin-left:10px" action="reject" id="'+data.tracker_id+'">OPEN BOOM GATE</button>';
      
}else if(data.status=="PEX"){
  status_txt="Pending Exit";
  txt_color ="yellow";

  button_part=    '<button class="col button button-outline button-round update-btn" style="color:red;border-color:red;margin-right:10px" action="reject_exit" id="'+data.tracker_id+'">REJECT</button>'+
                    '<button class="col button button-outline button-round update-btn" style="color:#38DB69;border-color:#38DB69;margin-left:10px" action="approved_exit" id="'+data.tracker_id+'">OPEN BOOM GATE</button>';
      

}

var check_in = data.created_at;
   


  
  var  check_out ='';
  var show_check_out='';
if(data.status=="PEX"){
    check_out = data.updated_at;
    show_check_out="<div class='row' >"+
                    "<div class='col-40'><label>Check-out</label></div>"+
                    "<div class='col-60'><label style='float:right;text-align: right;'>"+check_out+"</label></div>"+
                  '</div>';
  }
  
   
        var address="";
        var address_tittle="";
            if(data.entry_type!="I"){
              address=  data.lot.name+","+data.lot.street.name+","+data.lot.street.area.name;
              address_tittle = "Address";
            }else{
              address=  data.reason;
              address_tittle = "Purpose";
            }



    dynamicPopup = app.popup.create({
  content: '<div class="popup">'+
    '<div class="page">'+


      ' <div class="navbar">'+
               ' <div class="navbar-inner">'+
                  '<div class="left">'+
                    '<a class="link popup-close">'+
                        '<i class="material-icons"> arrow_back</i>'+
                   '   <span class="if-not-md">Back</span>'+
                   ' </a>'+
                 ' </div>'+
                 ' <div class="title">'+tittle+'</div>'+
               ' </div>'+
          '    </div>'+

          '<div class="toolbar toolbar-bottom">'+
                  
            '<div class="toolbar-inner" style="padding:5px 10px;">'+
           
              button_part+
                '</div>'+
            '</div>'+


              '<div class="page-content" >'+

              
          '<div class="block">'+

                '<div class="preview">'+
                '<div data-pagination="{\'el\': \'.swiper-pagination\'}" data-space-between="50" class="swiper-container demo-swiper">'+
                '<div class="swiper-pagination"></div>'+
                  '<div class="swiper-wrapper">'+
                    check_out_img+
                    '<div class="swiper-slide img-front camera_btn" x="EF" id="EF"><img src="'+data.entry_car_plate_image+'" class="custom-img" ></div>'+
                    '<div class="swiper-slide img-face camera_btn" x="FC" id="FC"><img src="'+data.driver_image+'" class="custom-img" ></div>'+
                    '<div class="swiper-slide img-face camera_btn" x="IC" id="IC"><img src="'+data.identity_image+'" class="custom-img" ></div>'+
                  '</div> '+
                '</div>'+
              '</div>'+
             

              '<div class="main_font" style="color:#FB6C5E;padding:0 5% ;font-size:2vh">'+

                  "<div class='row' >"+
                    "<div class='col-25'><label>Status</label></div>"+
                    "<div class='col-75'><label style='color:"+txt_color+";float:right;'>"+status_txt+"</label></div>"+
                  '</div>'+
                  "<div class='row' >"+
                    "<div class='col-40'><label>Vehicle Plate No.</label></div>"+
                    "<div class='col-60'><label style='float:right;'>"+data.visitor_car_plate+"</label></div>"+
                  '</div>'+
                  "<div class='row' >"+
                    "<div class='col-30'><label>"+address_tittle+"</label></div>"+
                    "<div class='col-70'><label style='float:right;text-align: right;'>"+address+"</label></div>"+
                  '</div>'+
                  "<div class='row' >"+
                    "<div class='col-40'><label>Check-in</label></div>"+
                    "<div class='col-60'><label style='float:right;text-align: right;'>"+check_in+"</label></div>"+
                  '</div>'+
                  show_check_out+

              '</div>'+


                '</div>'+

               

            '</div>'+'</div>'+

            '</div>',
   
});
dynamicPopup.open();
app.dialog.close();
app.swiper.create(".demo-swiper",{ pagination: {
    el: '.swiper-pagination',
    type: 'bullets',
  },
});

},function(error){
  app.dialog.close();
  console.log(error);
});
});



//* directly open boom gate (reason dialog) //////////////////////////////////////////////////////////////////////////////////
$$(".boom-gate-btn").on('click', function () {
 
  $$('#gate-type').val($$(this).data('value'));
  
  dynamicPopup.open();


});


// end ///////////////////////////////////////////////////////////////////////////////////////////////////////////////


        },pageBeforeOut:function(){
          var sck = socket.connect(CONFIG.SOCKET);
        //no function
          sck.removeListener;
    }
        
      }
}
            </script>
        